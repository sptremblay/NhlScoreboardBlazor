@page "/Scoreticker"
@using NhlScoreboard.Components
@using NhlScoreboard.Models
@inject HttpClient Http

<div class="d-flex flex-column align-items-center">
    <h1 class="title-score-info">@(CurrentScore.gameData.datetime.dateTime.ToLocalTime().Day == DateTime.Now.Day ? "TODAY" : "YESTERDAY")</h1>
    @if (@CurrentScore.gameData.status.statusCode == "3")
    {
        <h3>@CurrentScore.gameData.datetime.dateTime.ToLocalTime().ToString("HH:mm")</h3>
    }
    else
    {
        <h3>@CurrentScore.gameData.status.detailedState</h3>
    }
</div>

<div class="d-flex flex-row justify-content-around align-items-center">
    <TeamInfo Team="@CurrentScore?.gameData.teams.home"
              LeagueRecord="@CurrentScheduledGame?.teams.home.leagueRecord">
    </TeamInfo>
    <span class="middle-score-info">VS</span>
    
    <TeamInfo Team="@CurrentScore?.gameData.teams.away"
              LeagueRecord="@CurrentScheduledGame?.teams.away.leagueRecord">
    </TeamInfo>
</div>

@code {
    private List<Game> ScheduledGames { get; set; }
    private List<GameFeedLiveResponse> Scores { get; set; }
    private int scoreIndex = 0;
    private GameFeedLiveResponse CurrentScore { get; set; }
    private Game CurrentScheduledGame { get; set; }
    private TimeSpan dayChangeTime = new TimeSpan(10, 00, 00);

    protected override void OnInitialized()
    {
        base.OnInitialized();

        InvokeAsync(async () =>
        {
            ScheduledGames = await LoadSchedule();
            Scores = await RefreshScores();

            var refreshScreenTimer = new System.Threading.Timer((_) =>
            {
                CurrentScore = Scores[scoreIndex];
                CurrentScheduledGame = ScheduledGames.FirstOrDefault(f => f.gamePk == CurrentScore.gamePk);
                scoreIndex += 1;
                if (scoreIndex == ScheduledGames.Count)
                    scoreIndex = 0;
                StateHasChanged();
            }, null, 0, 5000);
        });
    }

    private async Task<List<Game>> LoadSchedule()
    {
        var date = DateTime.Now.ToString("yyyy-M-d");
        if (DateTime.Now.TimeOfDay < dayChangeTime) //if before 10 am ... load previous day
        {
            date = DateTime.Now.Subtract(new TimeSpan(1, 0, 0, 0)).ToString("yyyy-M-d");
        }
        var response = await Http.GetFromJsonAsync<ScheduleResponse>
            ($"https://statsapi.web.nhl.com/api/v1/schedule?&startDate={date}&endDate={date}");


        return response?.dates[0].games;
    }

    private async Task<List<GameFeedLiveResponse>> RefreshScores()
    {
        var gameFeeds = new List<GameFeedLiveResponse>();
        foreach (var game in ScheduledGames)
        {
            gameFeeds.Add(await Http.GetFromJsonAsync<GameFeedLiveResponse>
                ($"https://statsapi.web.nhl.com/api/v1/game/{game.gamePk}/feed/live"));
        }
        return gameFeeds;
    }






}