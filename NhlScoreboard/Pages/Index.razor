@page "/"
@using NhlScoreboard.Components
@using NhlScoreboard.Models
@using System.ComponentModel
@inject HttpClient Http

@if (scoreIndex == -1)
{
    <Clock />
}
else
{
    if (CurrentScore?.gameData.status.statusCode < 3)
    {
        <ScheduledGameInfo CurrentScheduledGame="@CurrentScheduledGame"/>
    }
    else
    {
        <LiveGameInfo CurrentScore="@CurrentScore" CurrentScheduledGame="@CurrentScheduledGame"/>
    }
}

@code {
    private List<Game> ScheduledGames { get; set; }
    private int scoreIndex = 0;
    private GameFeedLiveResponse CurrentScore { get; set; }
    private Game CurrentScheduledGame { get; set; }
    private TimeSpan dayChangeTime = new TimeSpan(11, 00, 00);

    protected override void OnInitialized()
    {
        base.OnInitialized();

        InvokeAsync(async () =>
        {
            ScheduledGames = await LoadSchedule();
            var refreshSchedule = new System.Threading.Timer((_) =>
            {
                InvokeAsync(async () =>
                {
                    await LoadSchedule();
                });
            }, null, 0, 300000);

            var refreshScreenTimer = new System.Threading.Timer((_) =>
            {
                if (scoreIndex >= 0)
                {
                    CurrentScheduledGame = ScheduledGames[scoreIndex];
                    if (CurrentScheduledGame.status.statusCode == 3)
                    {
                        InvokeAsync(async () =>
                        {
                            CurrentScore = await Http.GetFromJsonAsync<GameFeedLiveResponse>
                                ($"https://statsapi.web.nhl.com/api/v1/game/{CurrentScheduledGame.gamePk}/feed/live");
                        });
                    }
                }
                scoreIndex += 1;
                if (scoreIndex == ScheduledGames.Count)
                    scoreIndex = -1;
                StateHasChanged();
            }, null, 0, 5000);
        });
    }

    private async Task<List<Game>> LoadSchedule()
    {
        var date = DateTime.Now.ToString("yyyy-M-d");
        if (DateTime.Now.TimeOfDay < dayChangeTime) //if before 10 am ... load previous day
        {
            date = DateTime.Now.Subtract(new TimeSpan(1, 0, 0, 0)).ToString("yyyy-M-d");
        }
        var response = await Http.GetFromJsonAsync<ScheduleResponse>
            ($"https://statsapi.web.nhl.com/api/v1/schedule?&startDate={date}&endDate={date}");

        return response?.dates[0].games;
    }

}