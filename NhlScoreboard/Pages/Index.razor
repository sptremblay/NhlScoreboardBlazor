@page "/"
@using NhlScoreboard.Components
@using NhlScoreboard.Models
@inject HttpClient Http

@if (CurrentScore?.gameData.status.statusCode < 3)
{
    <ScheduledGameInfo CurrentScore="@CurrentScore" CurrentScheduledGame="@CurrentScheduledGame"/>
}
else
{
    <LiveGameInfo CurrentScore="@CurrentScore" CurrentScheduledGame="@CurrentScheduledGame"/>
}

@code {
    private List<Game> ScheduledGames { get; set; }
    private List<GameFeedLiveResponse> Scores { get; set; }
    private int scoreIndex = 0;
    private GameFeedLiveResponse CurrentScore { get; set; }
    private Game CurrentScheduledGame { get; set; }
    private TimeSpan dayChangeTime = new TimeSpan(11, 00, 00);

    protected override void OnInitialized()
    {
        base.OnInitialized();

        InvokeAsync(async () =>
        {
            ScheduledGames = await LoadSchedule();
            Scores = await RefreshScores();

            var refreshScreenTimer = new System.Threading.Timer((_) =>
            {
                CurrentScore = Scores[scoreIndex];
                CurrentScheduledGame = ScheduledGames.FirstOrDefault(f => f.gamePk == CurrentScore.gamePk);
                scoreIndex += 1;
                if (scoreIndex == ScheduledGames.Count)
                    scoreIndex = 0;
                StateHasChanged();
            }, null, 0, 5000);
        });
    }

    private async Task<List<Game>> LoadSchedule()
    {
        var date = DateTime.Now.ToString("yyyy-M-d");
        if (DateTime.Now.TimeOfDay < dayChangeTime) //if before 10 am ... load previous day
        {
            date = DateTime.Now.Subtract(new TimeSpan(1, 0, 0, 0)).ToString("yyyy-M-d");
        }
        var response = await Http.GetFromJsonAsync<ScheduleResponse>
            ($"https://statsapi.web.nhl.com/api/v1/schedule?&startDate={date}&endDate={date}");

        return response?.dates[0].games;
    }

    private async Task<List<GameFeedLiveResponse>> RefreshScores()
    {
        var gameFeeds = new List<GameFeedLiveResponse>();
        foreach (var game in ScheduledGames)
        {
            gameFeeds.Add(await Http.GetFromJsonAsync<GameFeedLiveResponse>
                ($"https://statsapi.web.nhl.com/api/v1/game/{game.gamePk}/feed/live"));
        }
        return gameFeeds;
    }
}